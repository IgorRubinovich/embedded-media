<dom-module id="embedded-media">
	<style>
		:host {
			display : inline-block;
		}
		#content {
			position : relative;
			background : green; /* good for testing */
			opacity  : 0.5;
		}
		#cover {
			position : relative;
			top : 0;
			left : 0;
			background : red; /* good for testing */
			opacity  : 0.5;
		}
		#aspectKeeper {
			width : 100%;
			height : 0;
		}
		textarea : {
			margin : 20px;
		}
	</style>
	<template>
		<!-- displayed content -->
		<span id="content"><div id="aspectKeeper"><content></content></div><div id="cover"></div></span>
		
		<!-- setup dialaog -->
		<template is="dom-if" if="{{ _showDialog }}">
			<paper-dialog id="setupDialog">
				<textarea>{{ _originalInnerHTML }}</textarea>
				<embedded-media width="100">{{ _originalInnerHTML }}</embedded-media>
				<div>
					<paper-button on-tap="setupCancel">Cancel</paper-button>
					<paper-button on-tap="setupAccept">Accept</paper-button>
				</div>
			</paper-dialog>
		</template>
	</template>
</dom-module>

<script>
	(function () {
		Polymer({
			is : 'embedded-media',
			
			properties : [
				{ 
					name : "originalInnerHTML",
					type : String,
					observer : "originalInnerHTMLChanged"
				},				
				{ 
					name : "_originalInnerHTML",
					type : String
				},
				{ 
					name : "width",
					type : Number,
					notify : true,
					observer : "widthChanged"
				},
				{ 
					name : "height",
					type : Number,
					notify : true,
					observer : "widthChanged"
				},
				{ 
					name : "aspect",
					type : Number,
					notify : true,
				},
				{
					name : "_showDialog",
					type : Boolean
				}
				
			],
			
			widthChangedIframe : function() {
				//console.log('!! widthChangedIframe');

				var aspect, w, h, bcr = this.$.content.getBoundingClientRect();
				
				if(!(w = this.getAttribute('width')))
					w = this.iframe.width || bcr.width || this.$.content.scrollWidth;
				if(!(h = this.getAttribute('height')))
					h = this.iframe.height || bcr.height || this.$.content.scrollHeight;

				aspect = h / w;

				// set aspect attribute if not yet set
				if(!this.aspect && !(this.aspect = this.getAttribute('aspect')))
				{
					this.aspect = aspect;
					this.setAttribute('aspect', aspect);
				}
				else
					aspect = this.aspect;

				h = w * aspect;

				this.iframe.width = w;
				this.iframe.height = h;

				this.iframe.setAttribute('width', w);
				this.iframe.setAttribute('height', h);
				
				this.updateStyles(w, h);
			},
			
			// for scripted embeds like Twitter
			_widthChangedScript : function(reason) {
				var domMutated = reason == "domMutated";
			
				//console.log('!! widthChangedScript');
				var aspect, w, h, bcr = this.$.content.getBoundingClientRect(), maxw, maxh, update, minh, maxh;

				if(domMutated || !(w = this.width || this.getAttribute('width')))
					w = bcr.width || this.$.content.scrollWidth;
					
				h = this.$.content.scrollHeight || bcr.height;
				
				if(!(w && h))
					return;
					
				if(!domMutated)
					this.width || this.getAttribute('width', w);

				console.log();

				this.updateStyles(w, h, reason);
			},
			
			
			widthChangedScript : function(ev, postfactum) {
				var w, h, cw, ch, cbr, childrenSize;
				
				cbr = this.$.content.getBoundingClientRect()
				
				childrenSize = this.sizeFromChildNodes();
				
				//if(ev == 'attributeChanged')
				//{
				
				console.log('width changed, postfactum: ', postfactum);
				
				this.$.cover.style.width = childrenSize.maxw + "px"
				this.$.cover.style.height = childrenSize.maxh + "px"
				this.style.height = childrenSize.maxh + "px"
				this.style.width = childrenSize.maxw + "px"
				this.set('height', childrenSize.maxh);
				this.set('width', childrenSize.maxw);

				if(this.isInContentEditable)
				{				
					this.$.cover.style.width = w + "px";
					this.$.cover.style.height = h + "px";
				}
				
				if(!postfactum)
				{
					clearTimeout(this.lastTimeout);
					this.lastTimeout = setTimeout(function() {
						this.widthChangedScript(ev, true);
					}.bind(this), 1000);
				}
				//}
					//this.updateStyles(this.$.content.scrollWidth, this.$.content.scrollHiehgt)
				
				return
				
				if(this.lastTimeout && !postfactum)
					return;
			
				console.log("postfactum: %s, changed: %s, reason: %s", postfactum, this.changed, ev);
					
				clearTimeout(this.lastTimeout);
				this.lastTimeout = null;

				if(!postfactum)
				{
					if(ev == 'attributeChanged')
						this.maxw = this.minw = this.maxh = this.minh = 0;
					
					console.log('attribute changed non-postfactum');
					
					clearTimeout(this.lastTimeout);
					this.lastTimeout = setTimeout(function () { 
						this.widthChangedScript(ev, 1);
					}.bind(this), 10); //'domMutated' ? 100 : 300);
				}
				
				if(postfactum == 1)
				{
					this.sizeFromChildNodes();

					clearTimeout(this.lastTimeoutPF);
					this.lastTimeoutPF = setTimeout(function () { 
						this.widthChangedScript(ev, 2); 
					}.bind(this), 50 ); // check one more time because observer seems not to fire between last change and actual relayout

					if(postfactum == 1)
					{
						clearTimeout(this.lastTimeoutPF2);
						this.lastTimeoutPF2 = setTimeout(function () { 
							this.widthChangedScript(ev, 3);
						}.bind(this), 1000); //'domMutated' ? 100 : 300);
					}
				}
				
				this._widthChangedScript(ev);
			},
			
			sizeFromChildNodes : function() {
				var res = {}, 
					childNodes = this.$.aspectKeeper.childNodes,
					cw =  Array.prototype.filter.call(childNodes, function(el){ return el.clientWidth }).map(function(el) { return el.clientHeight && el.clientWidth }),
					ch =  Array.prototype.filter.call(childNodes, function(el){ return el.clientHeight }).map(function(el) { return el.clientHeight });

				if(cw.length)
				{
					res.maxw = Math.max.apply({}, cw);
					res.minw = Math.min.apply({}, cw);
				}
				if(ch.length)
				{
					res.maxh = Math.max.apply({}, ch);
					res.minh = ch.reduce(function(p, c) { return p + c });
				}
				
				return res;
			},

			widthChanged : function(ev) {
				if(!this.parentNode)
					return;
					
				if(this.script)
					this.widthChangedScript(ev);
				else
					this.widthChangedIframe();

			},

			updateStyles : function(w, h, reason) {
				var done;
			
				this.maxw && (w = Math.min(w, this.maxw));
				this.minw && (w = Math.max(w, this.minw));
				this.maxh && (h = Math.min(h, this.maxh));
				this.minh && (h = Math.max(h, this.minh));

				//this.$.content.style.width = w + "px";
				//this.$.content.style.height = h + "px";

				console.log("maxw: %s, minw: %s, maxh: %s, minh: %s, ", this.maxw, this.minw, this.maxh, this.minh);
				
				if(w == this._prevWidth && h == this._prevHeight)
					done = true;
					
				this._prevWidth = w;
				this._prevHeight = h;
				
				if(done)
				{
					console.log("finished resize with: ", [w, this._prevWidth, h, this._prevHeight]);					

					this.setAttribute('width', this.width = w);
					this.setAttribute('height', this.height = h);
				
					this.style.width = w + "px";
					this.style.height = h + "px";
					
					return this.changed = false;
				}

				if(!this.isInContentEditable)
					return;
				
				this.$.cover.style.width = w + "px";
				this.$.cover.style.height = h + "px";

				this.changed = true;
			},
			
			attributeChanged : function(name) {
				if(name == 'width')
					this.widthChanged('attributeChanged');
			},
			
			ready : function() {
				this.set('originalInnerHTML', Polymer.dom(this).innerHTML); //.$.aspectKeeper.innerHTML;
				this.$.content
				this.firstAttachment = true;
			},
			
			setupCancel : function(ev) {
				this.set('_showDialog', false);
				this.$.setupDialog.close();
			},
			
			setupAccept : function(ev)
			{
				this.set('_showDialog', false);
				//this.set('originalInnerHTML', this._originalInnerHTML);
				//this.$.setupDialog.close();
			},
			
			setup : function() {
				this.set('_originalInnerHTML', this.originalInnerHTML);
				this.set('_showDialog', true);				
				this.async(function() {
					this.$$('#setupDialog').open();
				});
			},
			
			originalInnerHTMLChanged : function() {
				this.firstAttachment = true;
				this.init();
				console.log('why??')
				
				Polymer.dom(this).innerHTML = this.originalInnerHTML
			},
			
			attached : function() {
				this.init();
			},
			
			init : function() {
				var p = this, firstChild, iframe, w, h, rect, mutationObserver, oconfig, cm;
				// if(!this.firstAttachment)
				// return;

				//this.$.aspectKeeper.innerHTML = this.originalInnerHTML;

				var interval, iframe, script;
				
				script = this.originalInnerHTML.match(/<script/) && Polymer.dom(this).querySelector('script');
				iframe = this.originalInnerHTML.match(/<iframe/) && Polymer.dom(this).querySelector('iframe');
				 
				this.iframe = Polymer.dom(this).childNodes.length && iframe;
				this.script = script;
				
				while(p.nodeType == 1 && (p = Polymer.dom(p).parentNode))
					if(p.hasAttribute && p.hasAttribute("contenteditable"))
						this.isInContentEditable = true;
				
				mutationObserver = new MutationObserver(function(mr) {
					this.widthChanged('domMutated');
				}.bind(this));
				
				oconfig = {
					childList : true,
					subtree : true,
					characterData : true,
					attributes : true
				}
				
				if(!iframe)
					oconfig.attributes = true;
								
				mutationObserver.observe(this.$.content, oconfig);

				// Polymer.dom(this).innerHTML = this.originalInnerHTML;
				
					//swapChildren(Polymer.dom(this));
				
				if(this.isInContentEditable)
					swapScripts(this);
				
			    if(this.firstAttachment && typeof(FB) != 'undefined') {
					// init script must be run by page master:
					// (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "//connect.facebook.net/en_US/all.js#xfbml=1"; fjs.parentNode.insertBefore(js, fjs); }(document, 'script', 'facebook-jssdk'));
					FB.XFBML.parse();
				}
				
				Polymer.dom.flush();
				this.widthChanged();
				
				this.firstAttachment = false;
			},
			
			domChanged : function() {
				console.log('dom changed!')
			}
		})
		
				
		function swapScripts (d) {
			var clone, attrs, pn;

			//document.body.appendChild(d);
			
			var s = Polymer.dom(d).querySelectorAll('script'), i;
			
			for(i = 0; i < s.length; i++)
			{
				clone = document.createElement('script');
				clone.appendChild(document.createTextNode(s[i].textContent));
				attrs = Array.prototype.slice.call(s[i].attributes);
				attrs.forEach(function(a) { clone.setAttribute(a.name, a.value); });

				pn = Polymer.dom(s[i]).parentNode; //Polymer.dom(s[i]).parentNode;

				if(!pn)
					return;

				Polymer.dom(pn).insertBefore(clone, s[i]);
				Polymer.dom(pn).removeChild(s[i]);
			}
			
			return s.length;
			//document.body.removeChild(d);
		}
		
		function swapChildren(d, skip) {
			var i, f = document.createDocumentFragment();;
			for(i = 0; i < d.childNodes.length; i++)
				f.appendChild(d.childNodes[i]);
			
			d.appendChild(f, d);
			//d.parentNode.removeChild(d);
		}
	})();
</script>
