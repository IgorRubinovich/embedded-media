<!--script src="../javascript-detect-element-resize/javascript-detect-element-resize.js"></script-->
<script src="../css-element-queries/src/ResizeSensor.js"></script>
<!-- script src="../ResizeSensor/ResizeSensorApi.js"></script -->


<dom-module id="embedded-media">
	<style>
	</style>
	size [[width]] [[height]]
	<template><content></content></template>
</dom-module>

<script>
	(function () {
		Polymer({
			is : 'embedded-media',
			
			properties : {
				width : {
					value : 0,
					//observer : 'widthChanged',
					//notify : true
				},
				height : {
					value : 0,
					//observer : 'widthChanged',
					//notify : true
				}
			},

			created : function() { 
	
			},
			
			ready : function() {
			},
			
			attached : function() {	
				this.sizeFromContainer();
				ResizeSensor(Polymer.dom(this).parentNode, this.sizeFromContainer.bind(this));
				window.addEventListener('resize', this.sizeFromContainer.bind(this));
			},
			
			sizeFromContainer : function() {
				this.debounce('resizeMedia', this._sizeFromContainer, 50);
			},
			
			_sizeFromContainer : function() {
				var p = Polymer.dom(this).parentNode,
					content = Polymer.dom(this).firstChild,
					w, h, avw;

				if(!p)
					return;
					
				if(content.tagName == 'IFRAME')
				{
					if(!this.ratio) {
						this.original = {};
						this.original.width = content.width;
						this.original.height = content.height;
						this.ratio = Math.round((this.original.height * 100000) / (this.original.width));
						this.ratio = this.ratio / 100000;
					}

					avw = this.availableWidth();

					w = avw;
					h = Math.round(w * this.ratio);
					
					console.log("ratio", this.ratio)
					console.log("w:", w, "ow:", this.original.width, "w/w", w/this.original.width)
					console.log("h:", h, "oh:", this.original.height, "h/h", h/this.original.height)

					
					content.style.width = (content.width = w) + "px";
					content.style.height = (content.height = h) + "px";					
					
					console.log(content.style.width, content.style.height);
					console.log(content.width, content.height);

					this.set('width', w)
					this.set('height', h)

					content.src += '';
				}

			},
			
			widthChanged : function() {
				if(!this.resizedBefore)
					return this.resizedBefore = true;
				
				this.debounce('refresh', function() {
					var p, cl;
					p = Polymer.dom(this).parentNode;
					
					if(!p)
						return;

					p = Polymer.dom(p);
					cl = Polymer.dom(this).cloneNode(true);
					
					p.insertBefore(cl, this);
					Polymer.dom.flush();
					p.removeChild(this);
					Polymer.dom.flush();
				}, 100);
			},
			
			availableWidth : function() {
				var p, bcr, m;
				
				p = Polymer.dom(this).parentNode;
				if(!p)
					return;
				
				bcr = p.getBoundingClientRect();
				m = p.offsetWidth;
				
				do { 
					m = Math.min(p.offsetWidth, m);
					p = Polymer.dom(p).parentNode; 
				} while(p && p != document);
				return m;
			}

		});

		function swapScripts (d) {
			var clone, attrs, pn;
			
			var s = Polymer.dom(d).querySelectorAll('script'), i;
			
			for(i = 0; i < s.length; i++)
			{
				clone = document.createElement('script');
				clone.appendChild(document.createTextNode(s[i].textContent));
				attrs = Array.prototype.slice.call(s[i].attributes);
				attrs.forEach(function(a) { clone.setAttribute(a.name, a.value); });

				pn = Polymer.dom(s[i]).parentNode; //Polymer.dom(s[i]).parentNode;

				if(!pn)
					return;

				do { 
					m = Math.min(p.offsetWidth, m), p = p.parentNode; 
				} while(p && p != document)
					
				Polymer.dom(pn).insertBefore(clone, s[i]);
				Polymer.dom(pn).removeChild(s[i]);
			}
			
			return s.length;
		}
		
		function swapChildren(d, skip) {
			var i, f = document.createDocumentFragment();;
			for(i = 0; i < d.childNodes.length; i++)
				f.appendChild(d.childNodes[i]);
			
			d.appendChild(f, d);
		}
	})();
</script>
