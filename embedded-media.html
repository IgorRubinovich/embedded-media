<dom-module id="embedded-media">
	<style>
		:host {
			display : inline-block;
		}
		#content {
			position : relative;
			background : green; /* good for testing */
			opacity  : 0.2;
		}
		#cover {
			position : relative;
			top : 0;
			left : 0;
			background : red; /* good for testing */
			opacity  : 0.2;
		}
		#aspectKeeper {
			width : 100%;
			height : 0;
		}
		textarea {
			margin : 20px;
			padding : 2px;
		}

	</style>
	<template>
		<!-- displayed content -->
		<span id="content"><div id="aspectKeeper"><content></content></div><div id="cover"></div></span>
		
		<!-- setup dialaog -->
		<template is="dom-if" if="{{ _showPreview }}">
			<paper-dialog id="setupDialog" fit>
				<div>
				<textarea id="htmlInputBox" rows="6" cols="50" on-change="_updateOriginalInnerHTML"> </textarea>
				<!-- embedded-media id="preview" preview width="100"></embedded-media -->
				<div>
					<div id="preview"></div>
				</div>
				<div>
					<paper-button on-tap="_updateOriginalInnerHTML">Preview</paper-button>
					<paper-button on-tap="setupCancel">Cancel</paper-button>
					<paper-button on-tap="setupAccept">Accept</paper-button>
				</div>
			</paper-dialog>
		</template>
	</template>
</dom-module>

<script>
	(function () {
		Polymer({
			is : 'embedded-media',
			
			properties : {
				originalInnerHTML : { 
					type : String,
					notify : true
				},				
				_originalInnerHTML : { 
					type : String,
					notify : true
				},
				preview : { 
					type : Boolean,
					value : false,
					notify : true
				},				
				_showPreview : { 
					type : Boolean,
					value : false,
					notify : true
				},
				height : { 
					reflectToAttribute: true,
					type : Number,
					notify : true,
					observer : "widthChanged"
				},
				width : { 
					reflectToAttribute: true,
					type : Number,
					notify : true,
					observer : "widthChanged"
				},
				aspect : { 
					reflectToAttribute: true,
					type : Number,
					notify : true,
					observer : "widthChanged"
				},
				name : { 
					type : Number,
					notify : true
				}
			},
			
			widthChangedIframe : function() {
				//console.log('!! widthChangedIframe');

				var aspect, w, h, bcr = this.$.content.getBoundingClientRect();
				
				if(!(w = this.getAttribute('width')))
					w = this.iframe.width || bcr.width || this.$.content.scrollWidth;
				if(!(h = this.getAttribute('height')))
					h = this.iframe.height || bcr.height || this.$.content.scrollHeight;

				aspect = h / w;

				// set aspect attribute if not yet set
				if(!this.aspect && !(this.aspect = this.getAttribute('aspect')))
				{
					this.aspect = aspect;
					this.set('aspect', aspect);
				}
				else
					aspect = this.aspect;

				h = w * aspect;

				this.iframe.width = w;
				this.iframe.height = h;

				this.iframe.setAttribute('width', w);
				this.iframe.setAttribute('height', h);
				
				this.updateStyles(w, h);
			},
			
			// for scripted embeds like Twitter
			_widthChangedScript : function(reason) {
				var domMutated = reason == "domMutated";
			
				// console.log('!! widthChangedScript');
				var aspect, w, h, bcr = this.$.content.getBoundingClientRect(), maxw, maxh, update, minh, maxh;

				if(domMutated || !(w = this.width || this.getAttribute('width')))
					w = bcr.width || this.$.content.scrollWidth;
					
				h = this.$.content.scrollHeight || bcr.height;
				
				if(!(w && h))
					return;
					
				if(!domMutated)
					this.width || this.getAttribute('width', w);

				console.log();

				this.updateStyles(w, h, reason);
			},
			
			
			widthChangedScript : function(ev, postfactum) {
				var w, h, cw, ch, cbr, childrenSize;
				
				cbr = this.$.content.getBoundingClientRect()
				
				childrenSize = this.sizeFromChildNodes();
				
				this.style.height = childrenSize.maxh + "px"
				this.style.width = childrenSize.maxw + "px"
				this.set('height', childrenSize.maxh);
				this.set('width', childrenSize.maxw);
				
				this.$.content.style.width = childrenSize.maxw + "px"
				this.$.content.style.height = childrenSize.maxh + "px"
				
				if(this.isInContentEditable) // || this.preview)
				{				
					this.$.cover.style.width = childrenSize.maxw + "px"; //w + "px";
					this.$.cover.style.height = childrenSize.maxh + "px"; //h + "px";
				}
				
				if(!postfactum)
				{
					clearTimeout(this.lastTimeout);
					this.lastTimeout = setTimeout(function() {
						this.widthChangedScript(ev, true);
					}.bind(this), 1000);
				}
		
				this.fire('change', ev);

				//this.updateStyles(this.$.content.scrollWidth, this.$.content.scrollHiehgt)
				
				return
			},
			
			sizeFromAtrributes : function() {
			},
			
			sizeFromChildNodes : function() {
				var res = {}, 
					childNodes = this.$.aspectKeeper.childNodes,
					cw =  Array.prototype.filter.call(childNodes, function(el){ return el.clientWidth }).map(function(el) { return el.clientHeight && el.clientWidth }),
					ch =  Array.prototype.filter.call(childNodes, function(el){ return el.clientHeight }).map(function(el) { return el.clientHeight });

				if(cw.length)
				{
					res.maxw = Math.max.apply({}, cw);
					res.minw = Math.min.apply({}, cw);
				}
				if(ch.length)
				{
					res.maxh = Math.max.apply({}, ch);
					res.minh = ch.reduce(function(p, c) { return p + c });
				}
				
				return res;
			},

			widthChanged : function(ev) {
				if(!this.isInitialized)
					return;
				
				if(!this.isInContentEditable && !this.preview)
					return;
				
				if(!this.parentNode)
					return;
					
				if(this.iframe)
					this.widthChangedIframe();
				else
					this.widthChangedScript(ev);
			},

			updateStyles : function(w, h) {
				var done;

				///console.log("finished resize with: ", [w, this._prevWidth, h, this._prevHeight]);

				this.$.content.style.width = w + "px";
				this.$.content.style.height = h + "px";
				
				this.set('width',  w);
				this.set('height',  h);
				//this.setAttribute('width', this.width = w);
				//this.setAttribute('height', this.height = h);
			
				this.style.width = w + "px";
				this.style.height = h + "px";
				
				if(!this.isInContentEditable)
					return;

				this.$.cover.style.width = w + "px";
				this.$.cover.style.height = h + "px";
			},
			
			attributeChanged : function(name) {
				if(name == 'width')
					this.widthChanged('attributeChanged');
			},

			ready : function() {
				this.firstAttachment = true;
			},
			
			setupCancel : function(ev) {
				this.$$('#setupDialog').close();
				this.async(function() {
					this.connectObserver();
				});
			},
			
			setupAccept : function(ev)
			{
				this.originalInnerHTML = this._originalInnerHTML;
				this.originalInnerHTMLChanged();
				this.$$('#setupDialog').close();

				this.connectObserver();
			},
			
			setup : function() {
				if(this.preview)
					return;

				this.disconnectObserver();
				this.set('_showPreview', true);

				this.async(function() {
					this.$$('#setupDialog').open();
					this.set('_originalInnerHTML', this.originalInnerHTML);
					this._originalInnerHTMLChanged();
					this.$$('#htmlInputBox').focus();
					//this.$$("#preview").innerHTML = "<embedded-media>" + this._originalInnerHTML + "</embedded-media>";
				});
				
			},
			
			attached : function() {
				this.originalInnerHTML = Polymer.dom(this).innerHTML; //.$.aspectKeeper.innerHTML;
				this.init();
			},
			
			_updateOriginalInnerHTML : function(ev) {
				if(ev)
				{
					ev.stopPropagation();
					ev.stopImmediatePropagation();
					ev.preventDefault();
				}

				if(this._originalInnerHTML == this.$$('#htmlInputBox').value)
					return;

				this._originalInnerHTML = this.$$('#htmlInputBox').value;
				this._originalInnerHTMLChanged();				
			},

			_originalInnerHTMLChanged : function() {
				this.$$("#preview").innerHTML = "<embedded-media preview>" + this._originalInnerHTML + "</embedded-media>";

				Polymer.dom.flush();

				this.$$('#htmlInputBox').value = this._originalInnerHTML;
				this.$$('#htmlInputBox').focus();
				this.$$("#preview").firstChild.addEventListener('change', function() {
					clearTimeout(this._previewTimeout);
					this._previewTimeout = setTimeout(function() {
						var sd = this.$$('#setupDialog');
						sd.refit();
						sd.center();
					}.bind(this), 500);
				}.bind(this));
			},
			
			originalInnerHTMLChanged : function() {
				var p, clone;

				if(p = this.parentNode)
				{
					clone = Polymer.dom(this).cloneNode(false);
					Polymer.dom(clone).innerHTML = this.originalInnerHTML;
					this.parentNode.insertBefore(clone, this);
					this.parentNode.removeChild(this);
					return;
				}
					
				this.disconnectObserver();
				this.firstAttachment = true;
				Polymer.dom(this).innerHTML = this.originalInnerHTML
				//this.init();
			},
			
			connectObserver : function()
			{
				var oconfig = {
					childList : true,
					subtree : true,
					characterData : true
				}
				
				if(!this.iframe)
					oconfig.attributes = true;
								
				this.mutationObserver.observe(this.$.content, oconfig);
			},

			disconnectObserver : function()
			{
				this.mutationObserver.disconnect();
			},

			init : function() {
				var p = this, firstChild, iframe, w, h, rect, mutationObserver, oconfig, cm;

				var interval, iframe, script;
				
				script = this.originalInnerHTML.match(/<script/) && Polymer.dom(this).querySelector('script');
				iframe = this.originalInnerHTML.match(/<iframe/) && Polymer.dom(this).querySelector('iframe');
				 
				this.iframe = Polymer.dom(this).childNodes.length && iframe;
				
				if(!this.preview)
					while(p.nodeType == 1 && (p = Polymer.dom(p).parentNode))
						if(p.hasAttribute && p.hasAttribute("contenteditable"))
							this.isInContentEditable = true;

				if(!this.mutationObserver)
					this.mutationObserver = new MutationObserver(function(mr) {
						this.widthChanged('domMutated');
					}.bind(this));
					
				this.connectObserver();
				
				if(this.width || this.height) 
					this.updateStyles(this.width, this.height);
				
				Polymer.dom.flush();

				swapScripts(this);
						
			    if(this.firstAttachment && typeof(FB) != 'undefined') {
					// for FB embeds to work init script must be run by page master:
					// (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "//connect.facebook.net/en_US/all.js#xfbml=1"; fjs.parentNode.insertBefore(js, fjs); }(document, 'script', 'facebook-jssdk'));
					FB.XFBML.parse(this.$.content);
				}
				
				this.firstAttachment = false;
				
				this.isInitialized = true;
				this.widthChanged();
			},
			
			domChanged : function() {
				console.log('dom changed!')
			}
		})
		
				
		function swapScripts (d) {
			var clone, attrs, pn;
			
			var s = Polymer.dom(d).querySelectorAll('script'), i;
			
			for(i = 0; i < s.length; i++)
			{
				clone = document.createElement('script');
				clone.appendChild(document.createTextNode(s[i].textContent));
				attrs = Array.prototype.slice.call(s[i].attributes);
				attrs.forEach(function(a) { clone.setAttribute(a.name, a.value); });

				pn = Polymer.dom(s[i]).parentNode; //Polymer.dom(s[i]).parentNode;

				if(!pn)
					return;

				Polymer.dom(pn).insertBefore(clone, s[i]);
				Polymer.dom(pn).removeChild(s[i]);
			}
			
			return s.length;
		}
		
		function swapChildren(d, skip) {
			var i, f = document.createDocumentFragment();;
			for(i = 0; i < d.childNodes.length; i++)
				f.appendChild(d.childNodes[i]);
			
			d.appendChild(f, d);
			//d.parentNode.removeChild(d);
		}
	})();
</script>
